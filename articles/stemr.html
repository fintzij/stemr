<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>stemr: Baysian Inference for Stochastic Epidemic Models via the Linear Noise Approximation • stemr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="stemr: Baysian Inference for Stochastic Epidemic Models via the Linear Noise Approximation">
<meta property="og:description" content="stemr">
<meta property="og:image" content="/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">stemr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/stemr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/fintzij/stemr/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="stemr_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="stemr_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="stemr_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>stemr: Baysian Inference for Stochastic Epidemic Models via the Linear Noise Approximation</h1>
                        <h4 class="author">Jonathan Fintz, Jon Wakefield, and Vladimir N. Minin</h4>
            
            <h4 class="date">2020-11-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/fintzij/stemr/blob/master/vignettes/stemr.Rmd"><code>vignettes/stemr.Rmd</code></a></small>
      <div class="hidden name"><code>stemr.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>This vignette demonstrates the basic functionalities of the <code>stemr</code> package. Broadly, the package simulates and fits stochastic epidemic models to partially observed incidence and prevalence data, and implements the Bayesian data augmentation framework presented in Fintzi, Wakefield, and Minin (2020). Simulation can be conducted using ordinary differential equations (ODEs), Gillespie’s direct algorithm (Gillespie, 1976), and using a restarting version of the linear noise approximation (LNA; Fintzi et al., 2020). Inference is conducted using ODEs or the LNA. This vignette, in particular, demonstrates how to simulating partially observed incidence data from an outbreak with SIR dyanmics and fit an SIR model to the data via the linear noise approximation. This corresponds to the procedure used in the coverage simulation in Fintzi et al., (2020).</p>
</div>
<div id="installing-and-loading-the-stemr-package" class="section level1">
<h1 class="hasAnchor">
<a href="#installing-and-loading-the-stemr-package" class="anchor"></a>Installing and loading the <code>stemr</code> package</h1>
<p>To install the <code>stemr</code> package, clone this repository and build the package from sources. Since <code>stemr</code> relies on compiled code, you . You should be able to rebuild in the usual way once you clone the package repo and install the other dependencies (odeintr, extraDistr, ggplot2, patchwork, Rcpp, RcppArmadillo, and BH).</p>
</div>
<div id="basic-example-partially-observed-incidence-from-an-outbreak-with-sir-dynamics" class="section level1">
<h1 class="hasAnchor">
<a href="#basic-example-partially-observed-incidence-from-an-outbreak-with-sir-dynamics" class="anchor"></a>Basic example: partially observed incidence from an outbreak with SIR dynamics</h1>
<p>As a basic example, we will simulate an outbreak with SIR dynamics and generate negative binomial incidence counts with a mean case detection rate of 0.5. Briefly, the SIR model describes the time-evolution of an outbreak homogeneously mixing population where each individual exists in one of three states - susceptible (S), infected (I), and recovered (R). Infection implies that an individual is infectious with no latent period, while recovery confers lifelong immunity. The waiting times between infection and recovery events are taken to be exponentially distributed and the rates of state transition change every time the population jumps to a different state. Hence, the transmission process is a Markov jump process. The rates at which infection and recovery events take place are <span class="math display">\[\lambda_{SI} = \beta S I,\ \text{and}\ \lambda_{IR} = \mu I,\]</span> where <span class="math inline">\(\beta\)</span> is the per-contact rate of infection, <span class="math inline">\(\mu\)</span> is the recovery rate, and <span class="math inline">\(S\)</span> and <span class="math inline">\(I\)</span> denote the numbers of susceptible and infectious individuals. The basic reproduction number under SIR dynamics is <span class="math inline">\(R_0 = \beta P/\mu\)</span>, where <span class="math inline">\(P=S+I+R\)</span> is the population size.</p>
<p>We initialize parameters and instatiate the SIR model in the code block below. The functions in the <code>stemr</code> package are documented and can be accessed in the usual way, e.g., <code><a href="../reference/rate.html">help(rate)</a></code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/fintzij/stemr">stemr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>

<span class="va">popsize</span> <span class="op">=</span> <span class="fl">1e4</span> <span class="co"># population size</span>

<span class="va">true_pars</span> <span class="op">=</span>
      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>R0     <span class="op">=</span> <span class="fl">1.5</span>,  <span class="co"># basic reproduction number</span>
        mu_inv <span class="op">=</span> <span class="fl">2</span>,    <span class="co"># infectious period duration = 2 days</span>
        rho    <span class="op">=</span> <span class="fl">0.5</span>,  <span class="co"># case detection rate</span>
        phi    <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>   <span class="co"># negative binomial overdispersion</span>

<span class="co"># initialize model compartments and rates</span>
<span class="va">strata</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> <span class="co"># no strata</span>
<span class="va">compartments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span><span class="op">)</span>

<span class="co"># rates initialized as a list of rate lists</span>
<span class="va">rates</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/rate.html">rate</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="st">"beta * I"</span>, <span class="co"># individual level rate (unlumped)</span>
            from <span class="op">=</span> <span class="st">"S"</span>,        <span class="co"># source compartment</span>
            to   <span class="op">=</span> <span class="st">"I"</span>,        <span class="co"># destination compartment</span>
            incidence <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,    <span class="co"># compute incidence of S2I transitions, required for simulating incidence data</span>
       <span class="fu"><a href="../reference/rate.html">rate</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="st">"mu"</span>,       <span class="co"># individual level rate</span>
            from <span class="op">=</span> <span class="st">"I"</span>,        <span class="co"># source compartment</span>
            to   <span class="op">=</span> <span class="st">"R"</span>,        <span class="co"># destination compartment</span>
            incidence <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="co"># compute incidence of I2R transitions (not required for simulating data)</span>

<span class="co"># list used for simulation/inference for the initial state, initial counts fixed.</span>
<span class="co"># state initializer a list of stem_initializer lists.</span>
<span class="va">state_initializer</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/stem_initializer.html">stem_initializer</a></span><span class="op">(</span>
          init_states <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="va">popsize</span><span class="op">-</span><span class="fl">10</span>, I <span class="op">=</span> <span class="fl">10</span>, R <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="co"># must match compartment names</span>
          fixed <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="co"># initial state fixed for simulation, we'll change this later</span>

<span class="co"># set the parameter values - must be a named vector</span>
<span class="va">parameters</span> <span class="op">=</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">true_pars</span><span class="op">[</span><span class="st">"R0"</span><span class="op">]</span> <span class="op">/</span> <span class="va">popsize</span> <span class="op">/</span> <span class="va">true_pars</span><span class="op">[</span><span class="st">"mu_inv"</span><span class="op">]</span>, <span class="co"># R0 = beta * P / mu</span>
    <span class="fl">1</span><span class="op">/</span><span class="va">true_pars</span><span class="op">[</span><span class="st">"mu_inv"</span><span class="op">]</span>,
    <span class="va">true_pars</span><span class="op">[</span><span class="st">"rho"</span><span class="op">]</span>,
    <span class="va">true_pars</span><span class="op">[</span><span class="st">"phi"</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">parameters</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="st">"mu"</span>, <span class="st">"rho"</span>, <span class="st">"phi"</span><span class="op">)</span>

<span class="co"># declare the initial time to be constant</span>
<span class="va">constants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>t0 <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="va">t0</span> <span class="op">&lt;-</span> <span class="fl">0</span>; <span class="va">tmax</span> <span class="op">&lt;-</span> <span class="fl">40</span>

<span class="co"># compile the model</span>
<span class="va">dynamics</span> <span class="op">&lt;-</span>
      <span class="fu"><a href="../reference/stem_dynamics.html">stem_dynamics</a></span><span class="op">(</span>
            rates <span class="op">=</span> <span class="va">rates</span>,
            tmax <span class="op">=</span> <span class="va">tmax</span>,
            parameters <span class="op">=</span> <span class="va">parameters</span>,
            state_initializer <span class="op">=</span> <span class="va">state_initializer</span>,
            compartments <span class="op">=</span> <span class="va">compartments</span>,
            constants <span class="op">=</span> <span class="va">constants</span>,
            compile_ode <span class="op">=</span> <span class="cn">T</span>,   <span class="co"># compile ODE functions</span>
            compile_rates <span class="op">=</span> <span class="cn">T</span>, <span class="co"># compile MJP functions for Gillespie simulation</span>
            compile_lna <span class="op">=</span> <span class="cn">T</span>,   <span class="co"># compile LNA functions</span>
            messages <span class="op">=</span> <span class="cn">F</span>       <span class="co"># don't print messages</span>
      <span class="op">)</span>

<span class="co"># list of emission distribution lists (analogous to rate specification)</span>
<span class="va">emissions</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/emission.html">emission</a></span><span class="op">(</span>meas_var <span class="op">=</span> <span class="st">"S2I"</span>, <span class="co"># transition or compartment being measured (S-&gt;I transitions)</span>
                distribution    <span class="op">=</span> <span class="st">"negbinomial"</span>,         <span class="co"># emission distribution</span>
                emission_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"phi"</span>, <span class="st">"S2I * rho"</span><span class="op">)</span>, <span class="co"># distribution pars, here overdispersion and mean</span>
                incidence       <span class="op">=</span> <span class="cn">TRUE</span>,                  <span class="co"># is the data incidence</span>
                obstimes        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">tmax</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="co"># vector of observation times</span>

<span class="co"># compile the measurement process</span>
<span class="va">measurement_process</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/stem_measure.html">stem_measure</a></span><span class="op">(</span>emissions <span class="op">=</span> <span class="va">emissions</span>,
               dynamics  <span class="op">=</span> <span class="va">dynamics</span>,
               messages  <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>

<span class="co"># put it all together into a stochastic epidemic model object</span>
<span class="va">stem_object</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/make_stem.html">make_stem</a></span><span class="op">(</span>dynamics <span class="op">=</span> <span class="va">dynamics</span>,
            measurement_process <span class="op">=</span> <span class="va">measurement_process</span><span class="op">)</span></code></pre></div>
<div id="simulating-an-outbreak-and-data" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-an-outbreak-and-data" class="anchor"></a>Simulating an outbreak and data</h2>
<p>Having compiled the model, we can simulate an outbreak and incidence (or prevalence) data using Gillespie’s direct algorith to simulate a MJP path, with the LNA, or deterministically with ODEs. Since we specified that the data should consist of incidence counts in instatiating the model, the simulation function will produce incidence data. The prevalence and incidence curves are plotted below.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_mjp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_stem.html">simulate_stem</a></span><span class="op">(</span>stem_object <span class="op">=</span> <span class="va">stem_object</span>, method <span class="op">=</span> <span class="st">"gillespie"</span>, full_paths <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">sim_lna</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_stem.html">simulate_stem</a></span><span class="op">(</span>stem_object <span class="op">=</span> <span class="va">stem_object</span>, method <span class="op">=</span> <span class="st">"lna"</span>, lna_method <span class="op">=</span> <span class="st">"approx"</span><span class="op">)</span>
<span class="va">sim_ode</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_stem.html">simulate_stem</a></span><span class="op">(</span>stem_object <span class="op">=</span> <span class="va">stem_object</span>, method <span class="op">=</span> <span class="st">"ode"</span><span class="op">)</span></code></pre></div>
<p><img src="stemr_files/figure-html/plot_sims-1.png" width="768"></p>
</div>
<div id="fitting-the-model-to-data" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-the-model-to-data" class="anchor"></a>Fitting the model to data</h2>
<p>We’ll keep the dataset simulated under the MJP (shown below) and fit an SIR model to the data.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">sim_mjp</span><span class="op">$</span><span class="va">datasets</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,
                <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y <span class="op">=</span> <span class="va">S2I</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Week"</span>, y <span class="op">=</span> <span class="st">"Count"</span>, title <span class="op">=</span> <span class="st">"Observed Incidence"</span><span class="op">)</span></code></pre></div>
<p><img src="stemr_files/figure-html/plot_dat-1.png" width="700"></p>
<p>We’ll need to recompile the measurement process with the simulated data fed to the data argument of the <code>stem_measure</code> function since the data was not present when the measurement process was originally compiled. There is no need to recompile the model dynamics object, although we’ll have to regenerate the object with the new measurement process.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">measurement_process</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/stem_measure.html">stem_measure</a></span><span class="op">(</span>emissions <span class="op">=</span> <span class="va">emissions</span>,
               dynamics <span class="op">=</span> <span class="va">dynamics</span>,
               data <span class="op">=</span> <span class="va">sim_mjp</span><span class="op">$</span><span class="va">datasets</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="va">stem_object</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/make_stem.html">make_stem</a></span><span class="op">(</span>dynamics <span class="op">=</span> <span class="va">dynamics</span>, 
            measurement_process <span class="op">=</span> <span class="va">measurement_process</span><span class="op">)</span></code></pre></div>
<p>In order to perform inference, we’ll need to specify a function for transforming the model parameters from their natural scale to the estimation scale on which the MCMC explores the posterior, a function for transforming parameters on their estimation scale to the natural scale on which they enter the model dynamics and measurement process, and a function that returns the log prior. We’ll parameterize the MCMC estimation scale in terms of the log basic reproduction number, log recovery rate, logit mean case detection rate, and log of the negative binomial overdispersion parameter. The functions are specified as follows and placed into a list of functions (note that it is critical that the function signatures follow the specification given below):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">### Parameterization in terms of log(R0) and log(mu)</span>
<span class="co">## Priors for log(R0), log(mu), logit(rho), phi</span>
<span class="co"># Parameters (natural scale): beta, mu, rho, phi</span>
<span class="co"># Parameters (estimation scale): log(beta * N / mu), log(mu), logit(rho), log(phi)</span>

<span class="co"># function to take params_nat and return params_est</span>
<span class="va">to_estimation_scale</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params_nat</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">params_nat</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">popsize</span> <span class="op">/</span> <span class="va">params_nat</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, <span class="co"># (beta,mu,N) -&gt; log(R0-1)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">params_nat</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,                     <span class="co"># mu -&gt; log(mu)</span>
        <span class="fu"><a href="../reference/logit.html">logit</a></span><span class="op">(</span><span class="va">params_nat</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>,                   <span class="co"># rho -&gt; logit(rho)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">params_nat</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>                     <span class="co"># phi -&gt; log(phi)</span>
<span class="op">}</span>

<span class="co"># function to take params_est and return params_nat</span>
<span class="va">from_estimation_scale</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params_est</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">params_est</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="va">params_est</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">popsize</span><span class="op">)</span><span class="op">)</span>, <span class="co"># (log(R0), log(mu), N) -&gt; beta = exp(log(R0) + log(mu) - log(N))</span>
        <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">params_est</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="co"># log(mu) -&gt; mu</span>
        <span class="fu"><a href="../reference/expit.html">expit</a></span><span class="op">(</span><span class="va">params_est</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, <span class="co"># logit(rho) -&gt; rho</span>
        <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">params_est</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co"># log(phi) -&gt; phi</span>
<span class="op">}</span>

<span class="co"># calculate the log prior density. note the jacobian for phi</span>
<span class="va">logprior</span> <span class="op">=</span>
      <span class="kw">function</span><span class="op">(</span><span class="va">params_est</span><span class="op">)</span> <span class="op">{</span>
            <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">params_est</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">0</span>, <span class="fl">0.5</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">params_est</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="op">-</span><span class="fl">0.7</span>, <span class="fl">0.35</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">params_est</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fl">0</span>, <span class="fl">1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">dexp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">params_est</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>, <span class="fl">0.1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="va">params_est</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>
      <span class="op">}</span>

<span class="co"># return all three functions in a list</span>
<span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>logprior <span class="op">=</span> <span class="va">logprior</span>,
               to_estimation_scale <span class="op">=</span> <span class="va">to_estimation_scale</span>,
               from_estimation_scale <span class="op">=</span> <span class="va">from_estimation_scale</span><span class="op">)</span></code></pre></div>
<p>We now specify the MCMC transition kernel. The main building block in the MCMC kernel is a list of parameter block lists, each specified via a call to the <code><a href="../reference/parblock.html">parblock()</a></code> function. In this simple example, we’ll update the model hyperparameters using a multivariate normal Metropolis-Hastings algorithm. We’ll tune the algorithm using a global adaptive scheme (algorithm 4 in Andrieu and Thoms). We’ll also initialize the parameters at random values, which is accomplished by specifying a function that adds noise to the parameters on their estimation scale.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">par_initializer</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">priors</span><span class="op">$</span><span class="fu">from_estimation_scale</span><span class="op">(</span><span class="va">priors</span><span class="op">$</span><span class="fu">to_estimation_scale</span><span class="op">(</span><span class="va">parameters</span><span class="op">)</span> <span class="op">+</span> 
                                 <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
  
<span class="co"># specify the kernel</span>
<span class="va">mcmc_kern</span> <span class="op">&lt;-</span>
        <span class="fu"><a href="../reference/mcmc_kernel.html">mcmc_kernel</a></span><span class="op">(</span>
          parameter_blocks <span class="op">=</span> 
              <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/parblock.html">parblock</a></span><span class="op">(</span>
                  pars_nat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="st">"mu"</span>, <span class="st">"rho"</span>, <span class="st">"phi"</span><span class="op">)</span>,
                  pars_est <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"log_R0"</span>, <span class="st">"log_mu"</span>, <span class="st">"logit_rho"</span>, <span class="st">"log_phi"</span><span class="op">)</span>,
                  priors <span class="op">=</span> <span class="va">priors</span>,
                  alg <span class="op">=</span> <span class="st">"mvnmh"</span>,
                  sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">4</span><span class="op">)</span>,
                  initializer <span class="op">=</span> <span class="va">par_initializer</span>,
                  control <span class="op">=</span> 
                    <span class="fu"><a href="../reference/mvnmh_control.html">mvnmh_control</a></span><span class="op">(</span>stop_adaptation <span class="op">=</span> <span class="fl">2.5e2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
          lna_ess_control <span class="op">=</span> <span class="fu"><a href="../reference/lna_control.html">lna_control</a></span><span class="op">(</span>bracket_update_iter <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We now run the MCMC algorithm to fit the model via ODEs (for the sake of time in compiling the vignette). To perform inference with the LNA, simply change the <code>method</code> argument to <code>method="lna"</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="../reference/fit_stem.html">fit_stem</a></span><span class="op">(</span>stem_object <span class="op">=</span> <span class="va">stem_object</span>,
             method <span class="op">=</span> <span class="st">"ode"</span>,
             mcmc_kern <span class="op">=</span> <span class="va">mcmc_kern</span>,
             thinning_interval <span class="op">=</span> <span class="fl">50</span>,
             iterations <span class="op">=</span> <span class="fl">5e2</span><span class="op">)</span></code></pre></div>
<p>The <code>fit_stem</code> function fits the model and returns a list of MCMC samples and latent epidemic paths. These can be accessed as follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">runtime</span> <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">results</span><span class="op">$</span><span class="va">runtime</span>
<span class="va">posterior</span> <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">results</span><span class="op">$</span><span class="va">posterior</span> <span class="co"># list with posterior objects</span></code></pre></div>
</div>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<p>Andrieu, C., and Thoms, J.. “A tutorial on adaptive MCMC.” <strong>Statistics and Computing</strong> 18.4 (2008): 343-373.</p>
<p>Fintzi, J., Wakefield, J., &amp; Minin, V. N. (2020). <strong>A linear noise approximation for stochastic epidemic models fit to partially observed incidence counts.</strong> arXiv preprint arXiv:2001.05099.</p>
<p>Gillespie, D. T. (1976). <strong>A general method for numerically simulating the stochastic time</strong> <strong>evolution of coupled chemical reactions.</strong> Journal of Computational Physics 22, 403–434.</p>
<p>Murray, I., Adams, R. P., and MacKay, D. J. C. (2010). <strong>Elliptical slice sampling.</strong> JMLR: W&amp;CP 9, 541–548.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jon Fintzi, Jon Wakefield, Vladimir Minin.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
