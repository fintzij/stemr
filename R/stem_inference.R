#' Perform inference for a stochastic epidemic model using either the linear
#' noise approximation or agent-based Bayesian data augmentation.
#'
#' @param stem_object a stochastic epidemic model object containing the dataset,
#'   model dynamics, and measurement process.
#' @param method either "lna" or "bda"
#' @param iterations number of iterations
#' @param priors Either a list of priors for model parameters, each generated by
#'   a call to the \link{\code{prior}} function, or a list of three functions
#'   supplied by the user with names "prior_density", "to_estimation_scale", and
#'   "from_estimation_scale" (N.B. All three must be supplied). The first of
#'   these functions should have two arguments that are numeric vectors of
#'   parameters on their natural and estimation scales, specified in that order.
#'   The functions for converting parameters to and from their estimation
#'   scales. IMPORTANT NOTES: 1) The scale conversion functions must include the
#'   dots argument, "...", in the function arguments. 2) The priors should not
#'   include priors for the initial compartment counts or t0, which are
#'   specified in the \code{\link{stem_initializer}} function and in the
#'   \code{t0_kernel} argument.
#' @param kernel MCMC transition kernel generated by a call to the
#'   \link{\code{kernel}} function. RWMH and adaptive RWMH are implemented for
#'   jointly updating the model parameters (not including the initial
#'   compartment counts which are handled separately).
#' @param t0_kernel output of \link{\code{t0_kernel}}, specifying the RWMH
#'   transition kernel for t0 and the truncated normal distribution prior.
#' @param thin_params thinning interval for posterior parameter samples,
#'   defaults to 1
#' @param thin_latent_proc thinning interval for latent paths, defaults to
#'   ceiling(iterations/100) so that every 100th path will be saved
#' @param n_ess_updates number of elliptical slice sampling updates per
#'   iteration (LNA)
#' @param messages should status messages be printed? defaults to TRUE.
#' @param monitor_MCMC should MCMC output be generated for the purposes of
#'   monitoring convergence (defaults to FALSE)? If so, the acceptance rate and
#'   the proposal covariance matrix (if adaptive RWMH is used) are printed
#'   whenever messages are printed.
#'
#' @return list with posterior samples for the parameters and the latent
#'   process, along with MCMC diagnostics.
#' @export
stem_inference <- function(stem_object, method, iterations, priors, kernel, t0_kernel = NULL, thin_params = 1, thin_latent_proc = ceiling(iterations/100), initialization_attempts = 500, n_ess_updates = 1, messages = FALSE, monitor_MCMC = FALSE) {

        # check that the data, dynamics and measurement process are all supplied
        if (is.null(stem_object$measurement_process$data) ||
            is.null(stem_object$dynamics) ||
            is.null(stem_object$measurement_process)) {
                stop("The dataset, dynamics, and measurement process must all be specified.")
        }

        # check that the kernel for t0 was provided if t0 is not fixed
        if(!stem_object$dynamics$t0_fixed && is.null(t0_kernel)) {
                stop("An MCMC transition kernel must be provided for t0 if it is not fixed.")
        }

        if(method == "lna") {

                # get the results
                results <- stem_inference_lna(stem_object,
                                              iterations,
                                              priors,
                                              kernel,
                                              t0_kernel,
                                              thin_params,
                                              thin_latent_proc,
                                              initialization_attempts = 500,
                                              n_ess_updates = n_ess_updates,
                                              messages,
                                              monitor_MCMC)

        } else if (method == "bda") {
                print("bda not yet implemented")
                # # check that the required objects are present in the stem object
                # check_stem_object(stem_object, method = "bda")
#
#                 # get the results
#                 results <- stem_inference_lna(stem_object,
#                                               iterations,
#                                               prior_dists,
#                                               proposal_kernels,
#                                               thin_params,
#                                               thin_latent_proc,
#                                               messages)
        }

        return(results)
}