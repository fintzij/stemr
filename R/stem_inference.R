#' Perform inference for a stochastic epidemic model using either ordinary
#' differential equations, the linear noise approximation, or agent-based
#' Bayesian data augmentation.
#'
#' @param stem_object a stochastic epidemic model object containing the dataset,
#'   model dynamics, and measurement process.
#' @param method either "ode", "lna", or "bda".
#' @param iterations number of iterations
#' @param priors A list of three functions supplied by the user with names
#'   "prior_density", "to_estimation_scale", and "from_estimation_scale" (N.B.
#'   All three must be supplied). The first of these functions should have two
#'   arguments that are numeric vectors of parameters on their natural and
#'   estimation scales, specified in that order. The functions for converting
#'   parameters to and from their estimation scales. IMPORTANT NOTES: 1) The
#'   scale conversion functions must include the dots argument, "...", in the
#'   function arguments. 2) The priors should not include priors for the initial
#'   compartment counts or t0, which are specified in the
#'   \code{stem_initializer} function and in the \code{t0_kernel} argument.
#' @param mcmc_kernel MCMC transition kernel generated by a call to the
#'   \code{kernel} function.
#' @param t0_kernel output of \code{t0_kernel}, specifying the RWMH transition
#'   kernel for t0 and the truncated normal distribution prior.
#' @param thin_params thinning interval for posterior parameter samples,
#'   defaults to 1
#' @param thin_latent_proc thinning interval for latent paths, defaults to
#'   ceiling(iterations/100) so that every 100th path will be saved
#' @param messages should status messages be printed? defaults to FALSE.
#' @param initialization_attempts number of initialization attempts
#' @param ess_args list of elliptical slice sampling arguments
#' @param print_progress interval at which to print progress to a text file. If
#'   0 (default) progress is not printed.
#'
#' @return list with posterior samples for the parameters and the latent
#'   process, along with MCMC diagnostics.
#' @export
stem_inference <-
        function(stem_object,
                 method,
                 iterations,
                 priors,
                 mcmc_kernel,
                 t0_kernel = NULL,
                 thin_params = ceiling(iterations / 1000),
                 thin_latent_proc = ceiling(iterations / 1000),
                 initialization_attempts = 500,
                 ess_args = NULL,
                 print_progress = 0,
                 status_filename = NULL,
                 messages = FALSE) {
            
        # check that the data, dynamics and measurement process are all supplied
        if (is.null(stem_object$measurement_process$data) ||
            is.null(stem_object$dynamics) ||
            is.null(stem_object$measurement_process)) {
                stop("The dataset, dynamics, and measurement process must all be specified.")
        }

        # check that the kernel for t0 was provided if t0 is not fixed
        if(!stem_object$dynamics$t0_fixed && is.null(t0_kernel)) {
                stop("An MCMC transition kernel must be provided for t0 if it is not fixed.")
        }

        if(method == "lna") {

              if(is.null(status_filename)) status_filename <- "LNA"
              
                # get the results
              results <-
                    stem_inference_lna(
                          stem_object = stem_object,
                          iterations = iterations,
                          priors = priors,
                          mcmc_kernel = mcmc_kernel,
                          t0_kernel = t0_kernel,
                          thin_params = thin_params,
                          thin_latent_proc = thin_latent_proc,
                          initialization_attempts = initialization_attempts,
                          ess_args = ess_args,
                          print_progress = print_progress,
                          status_filename = status_filename,
                          messages = messages
                    )
              
        } else if(method == "ode") {
              
              if(is.null(status_filename)) status_filename <- "ODE"

                # get the results
              results <-
                    stem_inference_ode(
                          stem_object = stem_object,
                          iterations = iterations,
                          priors = priors,
                          mcmc_kernel = mcmc_kernel,
                          t0_kernel = t0_kernel,
                          thin_params = thin_params,
                          thin_latent_proc = thin_latent_proc,
                          initialization_attempts = initialization_attempts,
                          ess_args = ess_args,
                          print_progress = print_progress,
                          status_filename = status_filename,
                          messages = messages
                )

        } else if (method == "bda") {
                print("bda not yet implemented")
                # # check that the required objects are present in the stem object
                # check_stem_object(stem_object, method = "bda")
#
#                 # get the results
#                 results <- stem_inference_lna(stem_object,
#                                               iterations,
#                                               prior_dists,
#                                               proposal_kernels,
#                                               thin_params,
#                                               thin_latent_proc,
#                                               messages)
        }

        class(results) <- "stemr_inference_list"
        return(results)
}