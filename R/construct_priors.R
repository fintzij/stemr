#' Construct a function for evaluating log prior densities of model parameters.
#'
#' @param priors list of parameters prior lists, each constructed via a call to
#'   the \code{\link{prior}} function.
#' @param param_codes vector of parameter codes as generated by the
#'   \code{\link{stem_dynamics}} function
#'
#' @return function to evaluate the prior densities, returning a vector
#' @export
construct_priors <- function(priors, param_codes) {

        # get the codes for the parameters that are initial state parameters
        codes <- param_codes[!grepl("_0", names(param_codes))]

        if(length(priors) != length(codes)) {
                if(setdiff(names(codes), sapply(priors, "[[", "parameter")) != "t0") {
                        stop("All parameters must be assigned a prior distribution.")
                }
        }

        # get the names of the parameters in the priors
        prior_params <- sapply(priors, "[[", "parameter")
        param_names  <- names(codes)

        # reorder the priors to match the parameters
        priors <- priors[match(param_names[which(names(codes) != "t0")], prior_params)]

        # get the transformations
        transformations <- sapply(priors, "[[", "scale")
        jacobian_terms  <- data.frame("linear" = "",
                                      "log"    = paste0(" + params_est[", seq_along(param_names),"]"),
                                      "logit"  = paste0(" - params_est[",seq_along(param_names),"] - ",
                                                        "2 * log(1 + exp(-params_est[",seq_along(param_names),"]))"))

        # get the distributions, scales, hyperparameters, parameters, and jacobian terms
        densities       <- paste0("d",sapply(priors, "[[", "distribution"))
        hyperpars       <- lapply(priors, "[[", "hyperpars"); hyperpar_args <- lapply(lapply(priors, "[[", "hyperpars"), names)
        hyperparameters <- mapply(paste, hyperpar_args, hyperpars, MoreArgs = list(collapse = ", ", sep = "="))
        parameters      <- paste0("params_nat[",seq_along(priors),"]")
        jacobian_terms  <- jacobian_terms[cbind(1:length(parameters),match(transformations, colnames(jacobian_terms)))]

        # generate the body of the function
        prior_fcn_body  <- paste0("sum(", paste0(densities,"(",
                                                 parameters,", ",
                                                 hyperparameters,", log = TRUE)",
                                                 jacobian_terms,
                                                 collapse = ",\n "),")")

        prior_fcn <- eval(parse(text = paste0("function(params_nat, params_est) {", prior_fcn_body, "}", sep = "\n")))

        return(prior_fcn)
}